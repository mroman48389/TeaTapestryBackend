# CI/CD: GitHub Actions workflow for automated linting and other CI/CD on push/pull requests.
name: Backend CI/CD  # workflow name (shows up in GitHub Actions tab)

# GitHub will run this workflow on pushes and pull requests for the "main" (production) branch.
on:
    # Tried a branch-based approach on the frontend. Trying a file-type based approach here just to
    # get experience in both types.  So instead of running jobs when main is pushed/pulled, it will 
    # run them when py or yml files are changed.
    push:
        paths:
            - '**.py'
            - '.github/workflows/backend.yml'
            - 'requirements.txt'
    pull_request:
        paths:
          - '**.py'

jobs:
    # Define a job, linting and testing coverage, to run on the GitHub Ubuntu virtual machine.
    linting-and-testing:
        runs-on: ubuntu-latest

        # On GitHub, Settings --> Secrets and variables --> Actions (Added as repository secrets)
        services:
          postgres:
            image: postgres:15

            env:
              POSTGRES_USER: ${{ secrets.CI_POSTGRES_USER }}
              POSTGRES_PASSWORD: ${{ secrets.CI_POSTGRES_PASSWORD }}
              POSTGRES_DB: ${{ secrets.CI_POSTGRES_DB }}

            ports:
              - 5432:5432

            # Health check to wait until Postgres is ready
            options: >-
              --health-cmd="pg_isready -U postgres"
              --health-interval=10s
              --health-timeout=5s
              --health-retries=5

        env:
          DATABASE_URL: "postgresql+psycopg2://${{ secrets.CI_POSTGRES_USER }}:${{ secrets.CI_POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.CI_POSTGRES_DB }}"
          # Ensure seed data doesn't vanish before pytest runs using a file-based SQLite DB.
          # Migrations, seeding, and tests will all use this file.
          # DATABASE_URL: "sqlite:///./test.db"
          # DATABASE_URL: "sqlite:///:memory:"

        # Tell GitHub Actions to inject secret values into the environment for backend use.
        # env:
        #     SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        #     SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
    
        steps:
            # Check out the repo code.
            - name: Checkout code
              uses: actions/checkout@v4

            # Install Python in virtual environment with version 4 of setup-python in GitHub Action.
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.13'

            # Install dependencies using specified package.json.
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pytest coverage ruff

            # - name: Run linting with Flake8
            #   run: flake8 .

            - name: Run Ruff
              run: ruff check . --fix

            - name: Run migrations
              run: alembic upgrade head

            - name: Seed tea_profiles database
              run: python -m src.app.seed_tea_profiles

            - name: Ingest tea_profiles data
              run: python -m src.app.ingest_tea_profiles

            # - name: Debug DB contents
            #   run: |
            #     python - <<'EOF'
            #     from src.utils.session_utils import get_session_cm
            #     from src.db.models.tea_profiles_model import TeaProfileModel

            #     with get_session_cm() as session:
            #         rows = session.query(TeaProfileModel).all()
            #         print(f"Found {len(rows)} tea profiles")
            #         for row in rows:
            #             print(row.id, row.name)
            #     EOF

            # pytest --cov=app runs tests and coverage, 
            # --cov-report=term-missing shows lines not covered by tests,
            # PYTHONPATH: . ensures "from app.main import app" works in CI
            - name: Run tests with coverage
              run: pytest --cov=src --cov-report=term-missing --cov-report=xml
              env:
                  PYTHONPATH: .
                  DATABASE_URL: "postgresql+psycopg2://${{ secrets.CI_POSTGRES_USER }}:${{ secrets.CI_POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.CI_POSTGRES_DB }}"
                  # DATABASE_URL: "sqlite:///./test.db"

            - name: Upload coverage to GitHub 
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage.xml